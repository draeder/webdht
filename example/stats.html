<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebDHT Signaling Statistics</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
    }
    
    h1, h2, h3 {
      color: #2c3e50;
    }
    
    .container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      text-transform: uppercase;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e1e1e1;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    tr:hover {
      background-color: #f5f7fa;
    }
    
    .active {
      color: #27ae60;
      font-weight: bold;
    }
    
    .inactive {
      color: #e74c3c;
    }
    
    .peer-details {
      margin-top: 10px;
      display: none;
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
    }
    
    .toggle-details {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .toggle-details:hover {
      background-color: #2980b9;
    }
    
    .refresh-button {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }
    
    .refresh-button:hover {
      background-color: #27ae60;
    }
    
    .last-updated {
      font-style: italic;
      color: #7f8c8d;
      margin-bottom: 20px;
    }
    
    .chart-container {
      height: 300px;
      margin-bottom: 30px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      background-color: #f8f9fa;
      border: 1px solid #e1e1e1;
      cursor: pointer;
    }
    
    .tab.active {
      background-color: white;
      border-bottom: none;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      .summary-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>WebDHT Signaling Statistics</h1>
  
  <button id="refreshButton" class="refresh-button">Refresh Statistics</button>
  <div id="lastUpdated" class="last-updated">Last updated: Never</div>
  
  <div class="container">
    <h2>Summary</h2>
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-label">Active Peers</div>
        <div id="activePeers" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Peers</div>
        <div id="totalPeers" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Bytes</div>
        <div id="totalBytes" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Signals</div>
        <div id="totalSignals" class="stat-value">0</div>
      </div>
    </div>
    
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-label">DHT Signals</div>
        <div id="totalDhtSignals" class="stat-value">0</div>
        <div id="dhtSignalPercent" style="font-size: 14px; color: #27ae60;">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Server Signals</div>
        <div id="totalServerSignals" class="stat-value">0</div>
        <div id="serverSignalPercent" style="font-size: 14px; color: #e74c3c;">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Bytes/Peer</div>
        <div id="avgBytes" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Signals/Peer</div>
        <div id="avgSignals" class="stat-value">0</div>
      </div>
    </div>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-tab="peers">Peer Statistics</div>
    <div class="tab" data-tab="connections">Connection Statistics</div>
  </div>
  
  <div id="peers-tab" class="tab-content active">
    <div class="container">
      <h2>Peer Statistics</h2>
      <table id="peerTable">
        <thead>
          <tr>
            <th>Peer ID</th>
            <th>Status</th>
            <th>Bytes</th>
            <th>Signals</th>
            <th>DHT Signals</th>
            <th>Server Signals</th>
            <th>Connections</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="peerTableBody">
          <!-- Peer data will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="connections-tab" class="tab-content">
    <div class="container">
      <h2>Connection Statistics</h2>
      <table id="connectionTable">
        <thead>
          <tr>
            <th>Source Peer</th>
            <th>Target Peer</th>
            <th>Bytes</th>
            <th>Signals</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="connectionTableBody">
          <!-- Connection data will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Function to format bytes to human-readable format
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Function to truncate peer IDs for display
    function truncatePeerId(peerId) {
      if (!peerId) return '';
      return peerId.substring(0, 8) + '...' + peerId.substring(peerId.length - 4);
    }
    
    // Store the open/closed state of detail sections
    const detailsState = {};
    
    // Function to fetch and display statistics
    async function fetchStats() {
      try {
        // Save the current state of all detail sections before updating
        document.querySelectorAll('.peer-details').forEach(detail => {
          const id = detail.id;
          detailsState[id] = detail.style.display === 'block';
        });
        
        // Save the state of toggle buttons
        document.querySelectorAll('.toggle-details').forEach(button => {
          const peerId = button.dataset.peerId;
          if (peerId) {
            const detailsId = `details-${peerId.replace(/[^a-zA-Z0-9]/g, '')}`;
            detailsState[`button-${detailsId}`] = button.textContent;
          }
        });
        
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        // Update summary statistics
        document.getElementById('activePeers').textContent = stats.activePeers;
        document.getElementById('totalPeers').textContent = stats.totalPeers;
        document.getElementById('totalBytes').textContent = formatBytes(stats.summary.totalBytes);
        document.getElementById('totalSignals').textContent = stats.summary.totalSignals;
        document.getElementById('totalDhtSignals').textContent = stats.summary.totalDhtSignals || 0;
        document.getElementById('totalServerSignals').textContent = stats.summary.totalServerSignals || 0;
        document.getElementById('avgBytes').textContent = formatBytes(stats.summary.averageBytes);
        document.getElementById('avgSignals').textContent = stats.summary.averageSignals;
        
        // Calculate and display percentages
        const totalSignals = stats.summary.totalSignals || 0;
        if (totalSignals > 0) {
          const dhtPercent = Math.round(((stats.summary.totalDhtSignals || 0) / totalSignals) * 100);
          const serverPercent = Math.round(((stats.summary.totalServerSignals || 0) / totalSignals) * 100);
          document.getElementById('dhtSignalPercent').textContent = `${dhtPercent}%`;
          document.getElementById('serverSignalPercent').textContent = `${serverPercent}%`;
        } else {
          document.getElementById('dhtSignalPercent').textContent = '0%';
          document.getElementById('serverSignalPercent').textContent = '0%';
        }
        
        // Update last updated time
        const now = new Date();
        document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        
        // Clear existing table data
        const peerTableBody = document.getElementById('peerTableBody');
        peerTableBody.innerHTML = '';
        
        const connectionTableBody = document.getElementById('connectionTableBody');
        connectionTableBody.innerHTML = '';
        
        // Populate peer table
        for (const [peerId, peerStat] of Object.entries(stats.peerStats)) {
          const row = document.createElement('tr');
          
          // Peer ID cell
          const peerIdCell = document.createElement('td');
          peerIdCell.textContent = truncatePeerId(peerId);
          peerIdCell.title = peerId;
          row.appendChild(peerIdCell);
          
          // Status cell
          const statusCell = document.createElement('td');
          statusCell.textContent = peerStat.active ? 'Active' : 'Inactive';
          statusCell.className = peerStat.active ? 'active' : 'inactive';
          row.appendChild(statusCell);
          
          // Bytes cell
          const bytesCell = document.createElement('td');
          bytesCell.textContent = formatBytes(peerStat.byteCount);
          row.appendChild(bytesCell);
          
          // Signals cell
          const signalsCell = document.createElement('td');
          signalsCell.textContent = peerStat.signalCount;
          row.appendChild(signalsCell);
          
          // DHT Signals cell
          const dhtSignalsCell = document.createElement('td');
          const dhtSignals = peerStat.dhtSignalCount || 0;
          dhtSignalsCell.textContent = dhtSignals;
          if (dhtSignals > 0) {
            dhtSignalsCell.style.color = '#27ae60';
            dhtSignalsCell.style.fontWeight = 'bold';
          }
          row.appendChild(dhtSignalsCell);
          
          // Server Signals cell
          const serverSignalsCell = document.createElement('td');
          const serverSignals = peerStat.serverSignalCount || 0;
          serverSignalsCell.textContent = serverSignals;
          if (serverSignals > 0) {
            serverSignalsCell.style.color = '#e74c3c';
          }
          row.appendChild(serverSignalsCell);
          
          // Connections cell
          const connectionsCell = document.createElement('td');
          const connectionCount = Object.keys(peerStat.connections).length;
          connectionsCell.textContent = connectionCount;
          row.appendChild(connectionsCell);
          
          // Actions cell
          const actionsCell = document.createElement('td');
          if (connectionCount > 0) {
            const detailsId = `details-${peerId.replace(/[^a-zA-Z0-9]/g, '')}`;
            const toggleButton = document.createElement('button');
            toggleButton.className = 'toggle-details';
            
            // Set button text based on saved state or default to 'Show Details'
            if (detailsState[detailsId]) {
              toggleButton.textContent = 'Hide Details';
            } else {
              toggleButton.textContent = 'Show Details';
            }
            
            toggleButton.dataset.peerId = peerId;
            toggleButton.onclick = function() {
              const detailsElement = document.getElementById(detailsId);
              
              if (detailsElement.style.display === 'none' || !detailsElement.style.display) {
                detailsElement.style.display = 'block';
                this.textContent = 'Hide Details';
                detailsState[detailsId] = true;
              } else {
                detailsElement.style.display = 'none';
                this.textContent = 'Show Details';
                detailsState[detailsId] = false;
              }
            };
            actionsCell.appendChild(toggleButton);
          }
          row.appendChild(actionsCell);
          
          peerTableBody.appendChild(row);
          
          // Add details row if there are connections
          if (connectionCount > 0) {
            const detailsRow = document.createElement('tr');
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 8; // Updated to match the number of columns in the table
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'peer-details';
            const detailsId = `details-${peerId.replace(/[^a-zA-Z0-9]/g, '')}`;
            detailsDiv.id = detailsId;
            
            // Restore the display state if it was previously open
            if (detailsState[detailsId]) {
              detailsDiv.style.display = 'block';
            }
            
            const detailsTable = document.createElement('table');
            detailsTable.innerHTML = `
              <thead>
                <tr>
                  <th>Connected To</th>
                  <th>Bytes</th>
                  <th>Signals</th>
                  <th>DHT Signals</th>
                  <th>Server Signals</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            `;
            
            const detailsTableBody = detailsTable.querySelector('tbody');
            
            for (const [targetId, connStat] of Object.entries(peerStat.connections)) {
              const connRow = document.createElement('tr');
              
              // Target ID cell
              const targetIdCell = document.createElement('td');
              targetIdCell.textContent = truncatePeerId(targetId);
              targetIdCell.title = targetId;
              connRow.appendChild(targetIdCell);
              
              // Bytes cell
              const connBytesCell = document.createElement('td');
              connBytesCell.textContent = formatBytes(connStat.byteCount);
              connRow.appendChild(connBytesCell);
              
              // Signals cell
              const connSignalsCell = document.createElement('td');
              connSignalsCell.textContent = connStat.signalCount;
              connRow.appendChild(connSignalsCell);
              
              // DHT Signals cell
              const connDhtSignalsCell = document.createElement('td');
              const dhtSignals = connStat.dhtSignalCount || 0;
              connDhtSignalsCell.textContent = dhtSignals;
              if (dhtSignals > 0) {
                connDhtSignalsCell.style.color = '#27ae60';
                connDhtSignalsCell.style.fontWeight = 'bold';
              }
              connRow.appendChild(connDhtSignalsCell);
              
              // Server Signals cell
              const connServerSignalsCell = document.createElement('td');
              const serverSignals = connStat.serverSignalCount || 0;
              connServerSignalsCell.textContent = serverSignals;
              if (serverSignals > 0) {
                connServerSignalsCell.style.color = '#e74c3c';
              }
              connRow.appendChild(connServerSignalsCell);
              
              // Status cell
              const connStatusCell = document.createElement('td');
              connStatusCell.textContent = connStat.active ? 'Active' : 'Inactive';
              connStatusCell.className = connStat.active ? 'active' : 'inactive';
              connRow.appendChild(connStatusCell);
              
              detailsTableBody.appendChild(connRow);
              
              // Also add to the connections tab
              const connectionRow = document.createElement('tr');
              
              // Source Peer cell
              const sourceCell = document.createElement('td');
              sourceCell.textContent = truncatePeerId(peerId);
              sourceCell.title = peerId;
              connectionRow.appendChild(sourceCell);
              
              // Target Peer cell
              const targetCell = document.createElement('td');
              targetCell.textContent = truncatePeerId(targetId);
              targetCell.title = targetId;
              connectionRow.appendChild(targetCell);
              
              // Bytes cell
              const bytesCell = document.createElement('td');
              bytesCell.textContent = formatBytes(connStat.byteCount);
              connectionRow.appendChild(bytesCell);
              
              // Signals cell
              const signalsCell = document.createElement('td');
              signalsCell.textContent = connStat.signalCount;
              connectionRow.appendChild(signalsCell);
              
              // Status cell
              const statusCell = document.createElement('td');
              statusCell.textContent = connStat.active ? 'Active' : 'Inactive';
              statusCell.className = connStat.active ? 'active' : 'inactive';
              connectionRow.appendChild(statusCell);
              
              connectionTableBody.appendChild(connectionRow);
            }
            
            detailsDiv.appendChild(detailsTable);
            detailsCell.appendChild(detailsDiv);
            detailsRow.appendChild(detailsCell);
            peerTableBody.appendChild(detailsRow);
          }
        }
      } catch (error) {
        console.error('Error fetching statistics:', error);
        // Error is logged to console but no alert is shown to the user
      }
    }
    
    // Set up tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Set up refresh button
    document.getElementById('refreshButton').addEventListener('click', fetchStats);
    
    // Initial fetch
    fetchStats();
    
    // Auto-refresh every 30 seconds (reduced from 10 seconds to make UI more stable)
    setInterval(fetchStats, 30000);
  </script>
</body>
</html>